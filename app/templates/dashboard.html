{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8 col-md-7">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Welcome, {{ user.username }}!</h4>
                </div>
                <div class="card-body">
                    <!-- Query Form -->
                    <div class="mb-4">
                        <h5>Ask Questions About Your Documents</h5>
                        <!-- Removed unwanted token text here -->
                        <form id="queryForm" action="{{ url_for('main.query_documents') }}" method="post">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="input-group">
                                <input type="text" name="query" class="form-control"
                                       placeholder="Ask a question about your documents..." required>
                                <div class="input-group-append">
                                    <button type="submit" class="btn btn-primary">
                                        <span id="searchIcon">üîç</span>
                                        <span id="loadingSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                                        Search
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Drag and Drop Upload -->
                    <div class="mb-4">
                        <h5>Upload New Document</h5>
                        <div id="dropZone" class="drop-zone border border-dashed rounded p-4 text-center">
                            <div class="drop-content">
                                <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                                <p>Drag & drop files here or click to browse</p>
                                <small class="text-muted">Supports .txt and .md files</small>
                            </div>
                            <input type="file" id="fileInput" name="file" class="d-none" accept=".txt,.md">
                        </div>
                        <div id="uploadProgress" class="progress mt-2 d-none">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="uploadError" class="text-danger mt-2 d-none"></div>
                    </div>
                </div>
            </div>

            <!-- Query History -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Recent Queries</h5>
                </div>
                <div class="card-body">
                    <div id="queryHistory">
                        {% if query_history %}
                            {% for query in query_history %}
                                <div class="query-item border-bottom pb-2 mb-2">
                                    <strong>Q:</strong> {{ query.query }}<br>
                                    <small class="text-muted">{{ query.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No queries yet. Ask a question to get started!</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4 col-md-5">
            <!-- User Files -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Your Files</h5>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% if files %}
                        <div class="list-group" style="overflow-x: auto; white-space: nowrap;">
                            {% for file in files %}
                                <div class="list-group-item" style="overflow: hidden; padding: 10px; display: inline-block; vertical-align: top; white-space: normal; min-width: 300px;">
                                    <div class="d-flex justify-content-between align-items-center" style="flex-wrap: wrap;">
                                        <div style="flex: 1 1 auto; min-width: 150px;">
                                            <strong>{{ file.filename }}</strong>
                                            <br>
                                            <small class="text-muted">{{ (file.size / 1024)|round(2) }} KB</small>
                                            <br>
                                            <small class="text-muted">Chunks: {{ file.chunks|length }}</small>
                                        </div>
                                        <div class="btn-group btn-group-sm" style="flex-shrink: 0; white-space: nowrap;">
                                            <button class="btn btn-outline-info preview-btn"
                                                    data-filename="{{ file.filename }}"
                                                    data-content="{{ file.content|default('No content available') }}">
                                                Preview
                                            </button>
                                            {% if not file.processed %}
                                            <form action="{{ url_for('main.process_file_route', file_id=file.id) }}" method="post" class="d-inline">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <button type="submit" class="btn btn-outline-primary">Process</button>
                                            </form>
                                            {% else %}
                                            <button class="btn btn-outline-success" disabled>
                                                <i class="fas fa-check"></i> Processed
                                            </button>
                                            {% endif %}
                                            <form action="{{ url_for('main.delete_file', file_id=file.id) }}" method="post" class="d-inline">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <button type="submit" class="btn btn-outline-danger"
                                                        onclick="return confirm('Are you sure you want to delete this file?')">
                                                    Delete
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No files uploaded yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- File Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" role="dialog" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">File Preview</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <pre id="previewContent" class="bg-light p-3 rounded" style="white-space: pre-wrap; max-height: 400px; overflow-y: auto;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Enhanced Drag and drop functionality
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const uploadProgress = document.getElementById('uploadProgress');
const progressBar = uploadProgress.querySelector('.progress-bar');

// Click to select file
dropZone.addEventListener('click', () => fileInput.click());

// Drag events for visual feedback
dropZone.addEventListener('dragenter', (e) => {
    e.preventDefault();
    dropZone.classList.add('highlight');
});

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('highlight');
});

dropZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    // Only remove highlight if not dragging over child elements
    if (!dropZone.contains(e.relatedTarget)) {
        dropZone.classList.remove('highlight');
    }
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('highlight');
    
    if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        handleFileUpload();
    }
});

fileInput.addEventListener('change', handleFileUpload);

let uploadRetryCount = 0;
const maxRetries = 3;

function handleFileUpload(retry = false) {
    if (fileInput.files.length) {
        const file = fileInput.files[0];

        // Check for empty file
        if (file.size === 0) {
            showUploadError('File is empty. Please select a file with content.');
            fileInput.value = ''; // Clear the input
            return;
        }

        // Check for special characters in filename
        const specialCharPattern = /[^a-zA-Z0-9._\- ]/;
        if (specialCharPattern.test(file.name)) {
            alert('Filename contains special characters. It will be uploaded as is, but ensure compatibility.');
        }

        // File size validation (10MB limit)
        const maxSize = 10 * 1024 * 1024; // 10MB in bytes
        if (file.size > maxSize) {
            showUploadError('File too large. Maximum file size is 10MB.');
            fileInput.value = ''; // Clear the input
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        // Append CSRF token to FormData
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        formData.append('csrf_token', csrfToken);

        if (!retry) {
            uploadProgress.classList.remove('d-none');
            clearUploadError();
            uploadRetryCount = 0;
        }

        // Update progress bar (simulated progress for better UX)
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 5;
            progressBar.style.width = `${Math.min(progress, 90)}%`;
            if (progress >= 90) clearInterval(progressInterval);
        }, 100);

        fetch("{{ url_for('main.upload') }}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            clearInterval(progressInterval);
            progressBar.style.width = '100%';

            if (data.success) {
                // Automatic page refresh after successful upload
                setTimeout(() => {
                    location.reload();
                }, 500);
            } else {
                showUploadError('Upload failed: ' + data.error);
                uploadProgress.classList.add('d-none');
                progressBar.style.width = '0%';
            }
        })
        .catch(error => {
            clearInterval(progressInterval);
            console.error('Upload error:', error);

            if (error.name === 'TypeError' && error.message.includes('fetch')) {
                // Network error - offer retry
                if (uploadRetryCount < maxRetries) {
                    uploadRetryCount++;
                    const retry = confirm(`Network connection lost. Retry upload? (${uploadRetryCount}/${maxRetries})`);
                    if (retry) {
                        setTimeout(() => handleFileUpload(true), 2000); // Retry after 2 seconds
                        return;
                    }
                } else {
                    showUploadError('Upload failed after multiple retries. Please check your connection and try again.');
                }
            } else {
                showUploadError('Upload error: ' + error.message);
            }
            uploadProgress.classList.add('d-none');
            progressBar.style.width = '0%';
        });
    }
}

function showUploadError(message) {
    const errorDiv = document.getElementById('uploadError');
    errorDiv.textContent = message;
    errorDiv.classList.remove('d-none');
}

function clearUploadError() {
    const errorDiv = document.getElementById('uploadError');
    errorDiv.textContent = '';
    errorDiv.classList.add('d-none');
}

// Query form loading spinner
const queryForm = document.getElementById('queryForm');
const searchIcon = document.getElementById('searchIcon');
const loadingSpinner = document.getElementById('loadingSpinner');

queryForm.addEventListener('submit', () => {
    searchIcon.classList.add('d-none');
    loadingSpinner.classList.remove('d-none');
});

// File preview functionality
document.querySelectorAll('.preview-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const filename = btn.dataset.filename;
        const content = btn.dataset.content;
        
        document.getElementById('previewModalLabel').textContent = `Preview: ${filename}`;
        document.getElementById('previewContent').textContent = content;
        
        $('#previewModal').modal('show');
    });
});
</script>

<style>
.drop-zone {
    border: 2px dashed #ccc;
    transition: all 0.3s ease;
    cursor: pointer;
}

.drop-zone:hover,
.drop-zone.border-primary,
.drop-zone.highlight {
    border-color: #007bff;
    background-color: #f8f9fa;
}

.drop-zone.highlight {
    border-width: 3px;
    background-color: #e3f2fd;
}

.border-dashed {
    border-style: dashed !important;
}

.query-item {
    transition: background-color 0.2s ease;
}

.query-item:hover {
    background-color: #f8f9fa;
}

.list-group-item {
    transition: background-color 0.2s ease;
}

.list-group-item:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %}
