{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Welcome Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card glow-primary">
                <div class="card-body py-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="mb-2"><i class="fas fa-user-circle me-3 text-primary"></i>Welcome back, {{ user.username }}!</h2>
                            <p class="mb-0 text-muted">Ready to explore your documents with AI-powered insights.</p>
                        </div>
                        <div class="col-md-4 text-end">
                            {% if user.is_pilot %}
                                <span class="badge bg-success fs-6 px-3 py-2">
                                    <i class="fas fa-star me-2"></i>Premium Member
                                </span>
                            {% else %}
                                <span class="badge bg-outline-primary fs-6 px-3 py-2">
                                    <i class="fas fa-user me-2"></i>Free Plan
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Main Content Area -->
        <div class="col-lg-8">
            <!-- Quick Actions Row -->
            <div class="row g-3 mb-4">
                <!-- AI Query Card -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <div class="mb-3">
                                <i class="fas fa-brain fa-3x text-primary"></i>
                            </div>
                            <h5 class="card-title">Ask AI Questions</h5>
                            <p class="card-text text-muted">Get intelligent answers from your documents</p>
                            <button class="btn btn-primary w-100" data-bs-toggle="collapse" data-bs-target="#querySection">
                                <i class="fas fa-search me-2"></i>Start Querying
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Upload Card -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <div class="mb-3">
                                <i class="fas fa-cloud-upload-alt fa-3x text-success"></i>
                            </div>
                            <h5 class="card-title">Upload Documents</h5>
                            <p class="card-text text-muted">Add new files to your knowledge base</p>
                            <button class="btn btn-success w-100" data-bs-toggle="collapse" data-bs-target="#uploadSection">
                                <i class="fas fa-plus me-2"></i>Upload File
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Collapsible Query Section -->
            <div class="collapse mb-4" id="querySection">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-search me-2"></i>Ask Questions About Your Documents</h5>
                    </div>
                    <div class="card-body">
                        <form id="queryForm" action="{{ url_for('main.query_documents') }}" method="post">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="input-group input-group-lg">
                                <input type="text" name="query" class="form-control"
                                       placeholder="Example: What are the main topics discussed in my documents?" required>
                                <button type="submit" class="btn btn-primary">
                                    <span id="searchIcon"><i class="fas fa-search me-2"></i></span>
                                    <span id="loadingSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                                    Search
                                </button>
                            </div>
                            <small class="text-muted mt-2 d-block">💡 Try questions like "Summarize the key points" or "What are the main conclusions?"</small>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Collapsible Upload Section -->
            <div class="collapse mb-4" id="uploadSection">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-cloud-upload-alt me-2"></i>Upload New Document</h5>
                    </div>
                    <div class="card-body">
                        <div id="dropZone" class="drop-zone p-4 text-center">
                            <div class="drop-content">
                                <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
                                <h5>Drag & drop files here</h5>
                                <p class="text-muted mb-3">or <button class="btn btn-link p-0 text-primary" onclick="document.getElementById('fileInput').click()">browse your computer</button></p>
                                <div class="row text-start">
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <i class="fas fa-check text-success me-1"></i>Supports .txt and .md files<br>
                                            <i class="fas fa-check text-success me-1"></i>Up to 10MB per file
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle text-info me-1"></i>Files are processed securely<br>
                                            <i class="fas fa-lock text-warning me-1"></i>Enterprise-grade encryption
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <input type="file" id="fileInput" name="file" class="d-none" accept=".txt,.md">
                        </div>
                        <div id="uploadProgress" class="progress mt-3 d-none">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="uploadError" class="alert alert-danger mt-3 d-none"></div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Activity</h5>
                </div>
                <div class="card-body">
                    <div id="queryHistory">
                        {% if query_history %}
                            <div class="timeline">
                                {% for query in query_history %}
                                    <div class="timeline-item mb-3 pb-3 border-bottom">
                                        <div class="d-flex">
                                            <div class="timeline-marker bg-primary me-3">
                                                <i class="fas fa-search text-white"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-start mb-1">
                                                    <strong class="text-primary">Query:</strong>
                                                    <small class="text-muted">{{ query.timestamp.strftime('%m/%d %H:%M') }}</small>
                                                </div>
                                                <p class="mb-0">{{ query.query }}</p>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-5">
                                <span class="display-4 mb-3"></span>
                                <i class="fas fa-inbox fa-2x text-muted mb-3"></i>
                                <h6 class="text-muted">No activity yet</h6>
                                <p class="text-muted mb-0">Start by uploading a document or asking a question!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Account Status -->
            {% if user.is_pilot %}
            <div class="card mb-4 border-success glow-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-star me-2"></i>DocHub Pilot Member</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-crown fa-3x text-warning mb-2"></i>
                        <h6 class="text-success">Premium Access Unlocked!</h6>
                    </div>
                    <div class="alert alert-success py-2">
                        <small><strong>Member since:</strong> {{ user.pilot_purchased_at.strftime('%B %d, %Y') if user.pilot_purchased_at else 'Recently' }}</small>
                    </div>
                    <div class="premium-benefits">
                        <h6 class="mb-2">🎁 Your Benefits:</h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <small class="d-block">
                                    <i class="fas fa-check text-success me-1"></i>Unlimited uploads
                                </small>
                            </div>
                            <div class="col-6">
                                <small class="d-block">
                                    <i class="fas fa-check text-success me-1"></i>Advanced AI
                                </small>
                            </div>
                            <div class="col-6">
                                <small class="d-block">
                                    <i class="fas fa-check text-success me-1"></i>Priority support
                                </small>
                            </div>
                            <div class="col-6">
                                <small class="d-block">
                                    <i class="fas fa-check text-success me-1"></i>Export features
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card mb-4 border-warning">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="fas fa-rocket me-2"></i>🚀 Upgrade to Premium</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <span class="badge bg-primary fs-5 px-3 py-2 mb-2">$150</span>
                        <p class="text-muted small">One-time payment, lifetime access</p>
                    </div>
                    <div class="upgrade-benefits mb-3">
                        <h6 class="mb-2">✨ Unlock Premium Features:</h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <small class="d-block">
                                    <i class="fas fa-plus text-primary me-1"></i>Unlimited uploads
                                </small>
                            </div>
                            <div class="col-6">
                                <small class="d-block">
                                    <i class="fas fa-plus text-primary me-1"></i>Advanced AI
                                </small>
                            </div>
                            <div class="col-6">
                                <small class="d-block">
                                    <i class="fas fa-plus text-primary me-1"></i>Priority support
                                </small>
                            </div>
                            <div class="col-6">
                                <small class="d-block">
                                    <i class="fas fa-plus text-primary me-1"></i>Export features
                                </small>
                            </div>
                        </div>
                    </div>
                    <form action="{{ url_for('main.create_checkout_session') }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-warning btn-lg w-100">
                            <i class="fas fa-credit-card me-2"></i>💳 Upgrade Now
                        </button>
                    </form>
                    <small class="text-muted d-block mt-2 text-center">Secure payment powered by Stripe</small>
                </div>
            </div>
            {% endif %}

            <!-- Document Library -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-folder me-2"></i>Your Documents</h5>
                    <small class="text-muted">({{ files|length }} files)</small>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% if files %}
                        <div class="document-list">
                            {% for file in files %}
                                <div class="document-item p-3 mb-2 rounded">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1 me-2">
                                            <div class="d-flex align-items-center mb-1">
                                                <i class="fas fa-file-alt text-primary me-2"></i>
                                                <strong class="d-block text-truncate" title="{{ file.filename }}">{{ file.filename }}</strong>
                                            </div>
                                            <small class="text-muted d-block">
                                                {{ (file.size / 1024)|round(2) }} KB • {{ file.chunks|length }} chunks
                                                {% if file.processed %}
                                                    <span class="badge bg-success ms-1">Processed</span>
                                                {% else %}
                                                    <span class="badge bg-warning ms-1">Processing</span>
                                                {% endif %}
                                            </small>
                                        </div>
                                        <div class="btn-group-vertical btn-group-sm">
                                            <button class="btn btn-outline-info btn-sm preview-btn mb-1"
                                                    data-filename="{{ file.filename }}"
                                                    data-content="{{ file.content|default('No content available') }}"
                                                    title="Preview">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if not file.processed %}
                                            <form action="{{ url_for('main.process_file_route', file_id=file.id) }}" method="post" class="d-inline">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <button type="submit" class="btn btn-outline-primary btn-sm mb-1" title="Process">
                                                    <i class="fas fa-cog"></i>
                                                </button>
                                            </form>
                                            {% else %}
                                            <button class="btn btn-outline-success btn-sm mb-1" disabled title="Processed">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            {% endif %}
                                            <form action="{{ url_for('main.delete_file', file_id=file.id) }}" method="post" class="d-inline">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <button type="submit" class="btn btn-outline-danger btn-sm"
                                                        onclick="return confirm('Are you sure you want to delete this file?')" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <span class="display-4 mb-3"></span>
                            <i class="fas fa-file-alt fa-2x text-muted mb-3"></i>
                            <h6 class="text-muted">No documents yet</h6>
                            <p class="text-muted mb-0 small">Upload your first document to get started with AI queries!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- File Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">File Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre id="previewContent" class="p-3 rounded" style="white-space: pre-wrap; max-height: 400px; overflow-y: auto; background-color: #161b22; color: #ffffff; border: 1px solid #30363d;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Enhanced Drag and drop functionality
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const uploadProgress = document.getElementById('uploadProgress');
const progressBar = uploadProgress.querySelector('.progress-bar');

// Click to select file
dropZone.addEventListener('click', () => fileInput.click());

// Drag events for visual feedback
dropZone.addEventListener('dragenter', (e) => {
    e.preventDefault();
    dropZone.classList.add('highlight');
});

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('highlight');
});

dropZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    // Only remove highlight if not dragging over child elements
    if (!dropZone.contains(e.relatedTarget)) {
        dropZone.classList.remove('highlight');
    }
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('highlight');
    
    if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        handleFileUpload();
    }
});

fileInput.addEventListener('change', handleFileUpload);

let uploadRetryCount = 0;
const maxRetries = 3;

function handleFileUpload(retry = false) {
    if (fileInput.files.length) {
        const file = fileInput.files[0];

        // Check for empty file
        if (file.size === 0) {
            showUploadError('File is empty. Please select a file with content.');
            fileInput.value = ''; // Clear the input
            return;
        }

        // Check for special characters in filename
        const specialCharPattern = /[^a-zA-Z0-9._\- ]/;
        if (specialCharPattern.test(file.name)) {
            alert('Filename contains special characters. It will be uploaded as is, but ensure compatibility.');
        }

        // File size validation (10MB limit)
        const maxSize = 10 * 1024 * 1024; // 10MB in bytes
        if (file.size > maxSize) {
            showUploadError('File too large. Maximum file size is 10MB.');
            fileInput.value = ''; // Clear the input
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        // Append CSRF token to FormData
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        formData.append('csrf_token', csrfToken);

        if (!retry) {
            uploadProgress.classList.remove('d-none');
            clearUploadError();
            uploadRetryCount = 0;
        }

        // Update progress bar (simulated progress for better UX)
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 5;
            progressBar.style.width = `${Math.min(progress, 90)}%`;
            if (progress >= 90) clearInterval(progressInterval);
        }, 100);

        fetch("{{ url_for('main.upload') }}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            clearInterval(progressInterval);
            progressBar.style.width = '100%';

            if (data.success) {
                // Automatic page refresh after successful upload
                setTimeout(() => {
                    location.reload();
                }, 500);
            } else {
                showUploadError('Upload failed: ' + data.error);
                uploadProgress.classList.add('d-none');
                progressBar.style.width = '0%';
            }
        })
        .catch(error => {
            clearInterval(progressInterval);
            console.error('Upload error:', error);

            if (error.name === 'TypeError' && error.message.includes('fetch')) {
                // Network error - offer retry
                if (uploadRetryCount < maxRetries) {
                    uploadRetryCount++;
                    const retry = confirm(`Network connection lost. Retry upload? (${uploadRetryCount}/${maxRetries})`);
                    if (retry) {
                        setTimeout(() => handleFileUpload(true), 2000); // Retry after 2 seconds
                        return;
                    }
                } else {
                    showUploadError('Upload failed after multiple retries. Please check your connection and try again.');
                }
            } else {
                showUploadError('Upload error: ' + error.message);
            }
            uploadProgress.classList.add('d-none');
            progressBar.style.width = '0%';
        });
    }
}

function showUploadError(message) {
    const errorDiv = document.getElementById('uploadError');
    errorDiv.textContent = message;
    errorDiv.classList.remove('d-none');
}

function clearUploadError() {
    const errorDiv = document.getElementById('uploadError');
    errorDiv.textContent = '';
    errorDiv.classList.add('d-none');
}

// Query form loading spinner
const queryForm = document.getElementById('queryForm');
const searchIcon = document.getElementById('searchIcon');
const loadingSpinner = document.getElementById('loadingSpinner');

queryForm.addEventListener('submit', () => {
    searchIcon.classList.add('d-none');
    loadingSpinner.classList.remove('d-none');
});

// File preview functionality
document.querySelectorAll('.preview-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const filename = btn.dataset.filename;
        const content = btn.dataset.content;

        document.getElementById('previewModalLabel').textContent = `Preview: ${filename}`;
        document.getElementById('previewContent').textContent = content;

        const modal = new bootstrap.Modal(document.getElementById('previewModal'));
        modal.show();
    });
});
</script>

<style>
.drop-zone {
    border: 2px dashed #ccc;
    transition: all 0.3s ease;
    cursor: pointer;
}

.drop-zone:hover,
.drop-zone.border-primary,
.drop-zone.highlight {
    border-color: #007bff;
    background-color: #f8f9fa;
}

.drop-zone.highlight {
    border-width: 3px;
    background-color: #e3f2fd;
}

.border-dashed {
    border-style: dashed !important;
}

.query-item {
    transition: background-color 0.2s ease;
}

.query-item:hover {
    background-color: #f8f9fa;
}

.list-group-item {
    transition: background-color 0.2s ease;
}

.list-group-item:hover {
    background-color: #f8f9fa;
}

/* New dashboard styles */
.timeline-marker {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.document-item {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    transition: all 0.2s ease;
}

.document-item:hover {
    background-color: #e9ecef;
    border-color: #007bff;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.premium-benefits .row > div {
    padding: 2px 0;
}

.upgrade-benefits .row > div {
    padding: 2px 0;
}
</style>
{% endblock %}
